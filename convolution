import openpyxl
from openpyxl import Workbook
from openpyxl.utils import get_column_letter
import re

def extract_type_from_brackets(value_b):
    matches = re.findall(r'\((.*?)\)', value_b)
    if matches:
        return matches[0]
    else:
        return ""
first_row_skipped = True

def create_new_excel_file(input_file_path, output_file_path):
    workbook = openpyxl.load_workbook(input_file_path)
    
    new_workbook = Workbook()
    new_sheet = new_workbook.active
    
    header = ["Cabinet", "Location", "Type", "Channel", "KKS", "CIR", "CONNECTION"]
    new_sheet.append(header)
    
    buff_a = None  
    next_buff_a = None  
    
    for sheet_name in workbook.sheetnames:
        sheet = workbook[sheet_name]
        
        i = 1
        j = 2
        
        while True:
            buff_a = None
            next_buff_a = None
            processed_rows = False
            
            for row in sheet.iter_rows(min_row=1, max_col=52, max_row=sheet.max_row):
                value_a = row[0].value
                value_b = row[i].value
                
                if isinstance(value_a, str) and value_a.isalpha():
                    if isinstance(value_b, str):
                        type_value = extract_type_from_brackets(value_b)
                        value_b = re.sub(r'\([^)]*\)', '', value_b)
                        location_value = value_a + value_b.lstrip('0')
                        if buff_a is None:
                            buff_a = row[0].row  
                        next_buff_a = row[0].row + 1 
                        first_row_skipped = False
                        

                if buff_a is None:
                    continue  

               
                if not first_row_skipped:
                  first_row_skipped = True
                  continue

                if row[i].fill.start_color.index != '00000000':  
                    channel_value = int(value_a)
                    kks = str(value_b)
                    cir = str(row[j].value)
                    new_sheet.append([sheet_name, location_value, type_value, channel_value, kks, cir, ''])
                    processed_rows = True


            i += 2
            j += 2
            if i > 52 or j > 52:  
                 break

            # all_white = True
            # for row in sheet.iter_rows(min_row=1, max_col=52, max_row=sheet.max_row):
            #     if i <= 52 and row[i].fill.start_color.index != '00000000':
            #         all_white = False
            #         break
            #     if j <= 52 and row[j].fill.start_color.index != '00000000':
            #         all_white = False
            #         break
            
            # if all_white:
            #     break 

            

    
    new_sheet.auto_filter.ref = new_sheet.dimensions  
    new_sheet.auto_filter.add_sort_condition("A2:B{}".format(new_sheet.max_row)) 

    new_workbook.save(output_file_path)
    print(f"Новый файл Excel сохранен как: {output_file_path}")

input_file_path = '/content/drive/MyDrive/Свертка_таблицы/10CRC11.xlsx'
output_file_path = '/content/drive/MyDrive/Свертка_таблицы/test.xlsx'

create_new_excel_file(input_file_path, output_file_path)
